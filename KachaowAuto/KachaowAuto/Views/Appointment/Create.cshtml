@model KachaowAuto.ViewModels.BookAppointmentViewModel

<h2>Book Appointment</h2>

<form asp-action="Create" method="post" class="mt-3">
    @Html.AntiForgeryToken()

    <div class="mb-3">
        <label class="form-label">Brand</label>
        <select class="form-select" asp-for="BrandId" id="brandSelect">
            <option value="">-- select brand --</option>
            @foreach (var b in ViewBag.Brands)
            {
                <option value="@b.BrandId" selected="@(Model.BrandId == b.BrandId)">
                    @b.BrandName
                </option>
            }
        </select>
        <span asp-validation-for="BrandId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Model</label>
        <select class="form-select"
                asp-for="ModelId"
                id="modelSelect"
                disabled="@(Model.BrandId == 0)">
            <option value="">-- select model --</option>
        </select>
        <span asp-validation-for="ModelId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Year</label>
        <input class="form-control" asp-for="Year" type="number" />
        <span asp-validation-for="Year" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">VIN</label>
        <input class="form-control" asp-for="VIN" />
        <span asp-validation-for="VIN" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Engine Type</label>
        <select class="form-select" asp-for="EngineTypeId" id="engineTypeSelect">
            <option value="">-- select engine type --</option>
            @foreach (var e in ViewBag.EngineTypes)
            {
                <option value="@e.EngineTypeId" selected="@(Model.EngineTypeId == e.EngineTypeId)">
                    @e.Name
                </option>
            }
        </select>
        <span asp-validation-for="EngineTypeId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Body Type</label>
        <select class="form-select" asp-for="BodyTypeId" id="bodyTypeSelect">
            <option value="">-- select body type --</option>
            @foreach (var b in ViewBag.BodyTypes)
            {
                <option value="@b.BodyTypeId" selected="@(Model.BodyTypeId == b.BodyTypeId)">
                    @b.Name
                </option>
            }
        </select>
        <span asp-validation-for="BodyTypeId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Service</label>
        <select class="form-select" asp-for="ServiceId">
            <option value="">-- select service --</option>
            @foreach (var s in ViewBag.Services)
            {
                <option value="@s.ServiceId" selected="@(Model.ServiceId == s.ServiceId)">
                    @s.Name
                </option>
            }
        </select>
        <span asp-validation-for="ServiceId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Workshop</label>
        <select class="form-select" asp-for="WorkshopId">
            <option value="">-- select workshop --</option>
            @foreach (var w in ViewBag.Workshops)
            {
                <option value="@w.WorkshopId" selected="@(Model.WorkshopId == w.WorkshopId)">
                    @w.Name (@w.Region?.Name)
                </option>
            }
        </select>
        <span asp-validation-for="WorkshopId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Scheduled Date</label>
        <input class="form-control"
               asp-for="ScheduledDate"
               type="datetime-local"
               value="@Model.ScheduledDate.ToString("yyyy-MM-ddTHH:mm")" />
        <span asp-validation-for="ScheduledDate" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Problem description</label>
        <textarea class="form-control" asp-for="ProblemDescription" rows="4"></textarea>
        <span asp-validation-for="ProblemDescription" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-primary">Book Appointment</button>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const brandSelect = document.getElementById('brandSelect');
        const modelSelect = document.getElementById('modelSelect');

        async function loadModels(brandId, selectedModelId) {
            modelSelect.innerHTML = '<option value="">-- select model --</option>';
            modelSelect.disabled = true;

            if (!brandId) return;

            const res = await fetch(`/Appointment/GetModelsByBrand?brandId=${brandId}`);
            if (!res.ok) return;

            const models = await res.json();

            for (const m of models) {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.name;

                if (selectedModelId && String(m.id) === String(selectedModelId)) {
                    opt.selected = true;
                }

                modelSelect.appendChild(opt);
            }

            modelSelect.disabled = models.length === 0;
        }

        brandSelect.addEventListener('change', (e) => loadModels(e.target.value, null));

        if (brandSelect.value) {
            loadModels(brandSelect.value, '@Model.ModelId');
        }
    </script>
}
